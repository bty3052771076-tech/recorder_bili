

你是一名熟悉 Python、bilibili 直播协议、WebSocket、ffmpeg、前后端开发的高级工程师。请为我实现一个本地运行的软件，只有两个核心功能：**功能1：录制 bilibili 直播（含视频+弹幕+礼物+SC），录制前可手动选择直播地址和录制时间**，**功能2：在本地网页中查看录制结果**。所有功能都要图形化，通过本地 8000 端口提供 HTML 页面。下面要求逐条实现，不要省略。

---

### 一、总体要求

1. 程序本地运行，无需公网。
2. 启动后在 `http://127.0.0.1:8000` 提供前端页面。
3. 后端推荐 Python（FastAPI 或 Flask），前端为原生 HTML/JS，直接可打开。
4. 所有录制输出统一保存在项目内的 `outputs/` 目录，按房间号+时间分文件夹。
5. 提供清晰的 API，返回 JSON。

---

### 二、功能1：录制直播（可选地址+可选录制时长）

目标：给定 bilibili 直播间号，或用户手动指定的直播流地址，开始录制，同时抓取弹幕/礼物/SC，并按用户设定的“录制时长/结束条件”停止。

**2.1 前端界面要求**
在首页放一个“录制控制面板”，包含：

1. 输入框：`room_id`（bilibili 直播间号）
2. 输入框：`自定义流地址`（可选，如果用户已经有解析好的 flv/hls 播放地址，可以直接填；若留空则由后端自己根据 room_id 去解析）
3. 输入框/选择器：`录制时长`（单位：分钟或秒），可以为空

   * 若用户填写录制时长，则到时间后自动停止录制
   * 若为空，则一直录到用户手动停止
4. 输入框或下拉：`输出目录`（可选，默认 `outputs/`）
5. 按钮：“开始录制”
6. 按钮：“停止录制”
7. 当前录制任务列表表格，显示：

   * 任务ID或room_id
   * 实际使用的流地址
   * 开始时间
   * 录制时长限制
   * 视频文件名
   * 弹幕文件名
   * 状态（录制中/已停止/出错）
8. 简单日志输出区，显示后端返回的错误或成功信息

**2.2 后端录制逻辑**

1. `POST /api/record/start` 接口参数示例：

   ```json
   {
     "room_id": "123456",
     "custom_stream_url": "https://example.com/live.flv",   // 可选
     "duration_seconds": 3600,                              // 可选，单位秒
     "output_dir": "outputs"
   }
   ```
2. 后端收到请求后：

   * 如果提供了 `custom_stream_url`，则直接用这个地址给 ffmpeg 录制
   * 否则根据 `room_id` 调用 bilibili 的直播间接口/页面，解析出真实流地址（推荐 flv），解析逻辑写清楚
   * 写一份元数据：room_id、实际使用的地址、开始时间、用户设定的录制时长
3. 启动 ffmpeg 录制到本地，文件名示例：

   * `outputs/{room_id}/{room_id}_20250101_120000.flv`
4. ffmpeg 要在子线程/子进程运行，不能阻塞服务
5. 如果请求里带了 `duration_seconds`：

   * 后端启动一个计时线程/协程，到时间后发送停止命令给 ffmpeg，并同时停止弹幕抓取
   * 前端列表中要能看到这是“限时录制”
6. `POST /api/record/stop` 要能手动停止指定任务（按 room_id 或任务id）

**2.3 弹幕/礼物/SC 抓取**

1. 录制开始时，同时启动一个弹幕客户端，连接 bilibili 弹幕 WebSocket（`wss://broadcastlv.chat.bilibili.com/sub` 这类），实现：

   * 认证包发送
   * 心跳包定时发送
   * 二进制数据解包（包含多包、压缩）
2. 至少识别并保存以下 `cmd`：

   * `DANMU_MSG`
   * `SUPER_CHAT_MESSAGE`
   * `SEND_GIFT`
   * `GUARD_BUY`
   * `INTERACT_WORD`
   * `LIVE`
   * `PREPARING`
3. 每条消息写到同一次录制对应的 JSONL 文件：

   * `outputs/{room_id}/{room_id}_20250101_120000_danmaku.jsonl`
   * 每行字段：`timestamp`（本地ISO或unix）、`room_id`、`cmd`、`raw`、已解析字段（用户名、内容、礼物名、数量、SC金额等）
4. 弹幕线程掉线要自动重连，直到录制任务结束

**2.4 时间对齐**

1. 录制启动的时间戳要记录下来，作为本次会话的 t=0
2. 弹幕文件中每条记录要写当前本地时间戳
3. 在说明中写清“后期可用录制启动时间把弹幕对到视频上”

**2.5 并行和多任务**

1. 使用一个 `manager` 管理所有录制任务
2. 每个任务含：

   * ffmpeg 进程/线程
   * 弹幕客户端线程
   * 任务配置（room_id、stream_url、duration_seconds）
   * 当前状态
3. 前端定时轮询 `GET /api/record/status` 获取任务列表

---

### 三、功能2：查看录制视频

**3.1 前端页面**

1. 在同一个页面做第二个区块“录制历史”
2. 通过 `GET /api/recordings` 列出 `outputs/` 下所有录制会话
3. 显示：room_id、开始时间、视频文件名、弹幕文件名、是否限时录制
4. 每条记录提供“播放”按钮，点击后：

   * 页面内用 `<video src="/video/...">` 播放本地文件
   * 下方用表格显示对应的弹幕 JSON 内容（可分页/只显示前100条）
5. 如果有多段文件，也要能列出来

**3.2 后端接口**
至少实现：

* `GET /api/recordings`：扫描输出目录，返回所有录制会话
* `GET /api/recordings/{session_id}`：返回单次录制的详情（视频路径、弹幕路径、开始时间、设定时长）
* `GET /video/{path}`：返回视频文件，供 `<video>` 播放
* `GET /danmaku/{path}`：返回该次录制的 JSONL 内容（可一次性返回或流式返回）
* `POST /api/record/start`：见上
* `POST /api/record/stop`：见上
* `GET /api/record/status`：返回当前正在录制的任务列表

---

### 四、前端实现

1. 用一个 `index.html` 实现两块区域
2. 用 `fetch` 调接口，端口写死 8000
3. 表单字段要包含：room_id、custom_stream_url、duration_seconds
4. 提交后刷新任务列表

---

### 五、目录结构示例

```text
bili_recorder_app/
  app.py                # 启动FastAPI/Flask，在0.0.0.0:8000
  recorder/
    __init__.py
    manager.py          # 管理所有任务，提供start/stop/list
    video_recorder.py   # 调ffmpeg，支持自定义流地址和限时录制
    danmu_client.py     # 连接b站弹幕WS，解析消息，写jsonl
    config.py
    utils.py
  web/
    index.html          # 前端页面，两个面板：录制、历史
  outputs/              # 保存视频和弹幕
  requirements.txt
  README.md
```

要求：

* `video_recorder.py` 要支持三种参数：room_id、custom_stream_url、duration_seconds
* `manager.py` 内部用字典保存任务，key 用任务id（可用room_id+时间），value 是任务对象
* 每个任务对象里要能返回当前状态给 API

---

### 六、关键协议说明

1. 在 `danmu_client.py` 中写清楚 bilibili 弹幕 WebSocket 握手、认证包、心跳包格式和时间间隔，给出实际代码
2. 写注释说明：如果 bilibili 协议字段变动，需要根据抓包更新
3. 在录制视频的代码中写注释说明：如果需要携带 Cookie 来取更高清的流，可以在请求头或 ffmpeg 的 URL 中加入 Cookie

---

### 七、扩展说明

1. 写出如何把 JSONL 弹幕转成 ASS 以便播放器弹幕叠加
2. 写出前端如何用定时器轮询 `/danmaku/...` 来做简单的弹幕飘屏
3. 写出如何把录制时长改成“定点结束”（比如录到今天23:00为止）

---

请根据上述全部要求，生成完整的后端代码（含任务管理、ffmpeg 调用、WebSocket 弹幕客户端、API 定义），以及前端的 `index.html` 示例代码，确保录制前可以选择“直播地址”和“录制时间”。不要写“略”“此处省略”。ffmpeg位于D:\ffmpeg\ffmpeg-8.0-essentials_build\bin。
